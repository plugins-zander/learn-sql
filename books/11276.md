# MSSQL

## 事务

### 事务与ACID属性

```

使用一个简单的例子来帮助理解事务：向公司添加一名新的雇员（见图12.1）。这里的过程由三个基本步骤组成：在雇员数据库中为雇员创建一条记录；为雇员分配部门；建立雇员的工资记录。如果这三步中的任何一步失败，如为新成员分配的雇员ID已经被其他人使用或者输入到工资系统中的值太大，系统就必须撤销在失败之前所有的变化，删除所有不完整记录的踪迹，避免以后的不一致和计算失误。前面的三项任务构成了一个事务。任何一个任务的失败都会导致整个事务被撤销，而使系统返回到以前的状态。 

```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235925.png)

```
在形式上，事务是由ACID属性标识的。术语“ACID”是一个简称，每个事务的处理必须满足ACID原则，即原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）和持久性（Durability）。
（1）原子性。原子性意味着每个事务都必须被认为是一个不可分割的单元。假设一个事务由两个或者多个任务组成，其中的语句必须同时成功，才能认为事务是成功的。如果事务失败，系统将会返回到事务以前的状态。
在添加雇员这个例子中，原子性指如果没有创建雇员相应的工资表和部门记录，就不可能向雇员数据库添加雇员。
原子的执行是一个或者全部发生或者什么也没有发生的命题。在一个原子操作中，如果事务中的任何一个语句失败，前面执行的语句都将返回，以保证数据的整体性没有受到影响。这在一些关键系统中尤其重要，现实世界的应用程序（如金融系统）执行数据输入或更新，必须保证不出现数据丢失或数据错误，以保证数据安全性。
（2）一致性。不管事务是完全成功完成还是中途失败，当事务使系统中的所有数据处于一致的状态时存在一致性。参照前面的例子，一致性是指，如果从系统中删除了一个雇员，则所有和该雇员相关的数据，包括工资数据和组的成员资格也要被删除。
（3）隔离性。隔离性是指，每个事务在它自己的空间发生，和其他发生在系统中的事务隔离，而且事务的结果只有在它完全被执行时才能看到。即使在这样的一个系统中同时发生了多个事务，隔离性原则也保证某个特定事务在完全完成之前，其结果是看不见的。
当系统支持多个同时存在的用户和连接时（如SQL Server），这就尤其重要。如果系统不遵循这个基本规则，就可能导致大量数据的破坏，如每个事务各自空间的完整性很快地被其他冲突事务所侵犯。
（4）持久性。持久性意味着，一旦事务执行成功，在系统中产生的所有变化将是永久的。即使系统崩溃，一个提交的事务仍然存在。当一个事务完成，数据库的日志已经被更新时，持久性就开始发生作用了。大多数RDBMS产品通过保存所有行为的日志来保证数据的持久性，这些行为是指在数据库中以任何方法更改数据。数据库日志记录了所有对于表的更新、查询、报表等。



```

### 多用户使用的问题

```
丢失更新（lost update）指，当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，因此最后的更新将重写由其他事务所做的更新，这将导致数据丢失。
脏读（dirty read）指，一个事务正在访问数据，而其他事务正在更新该数据，但尚未提交，此时就会发生脏读问题，即第一个事务所读取的数据是“脏”（不正确）数据，它可能会引起错误。
当一个事务多次访问同一行而且每次读取不同的数据时，会发生不可重复读（unrepeatable read）问题。不可重复读与脏读有相似之处，因为该事务也是正在读取其他事务正在更改的数据。当一个事务访问数据时，另外的事务也访问该数据并对其进行修改，因此就发生了由于第二个事务对数据的修改而导致第一个事务两次读到的数据不一样的情况，这就是不可重复读。
当一个事务对某行执行插入或删除操作，而该行属于某个事务正在读取的行的范围时，会发生幻读（phantom read）问题。事务第一次读的行范围显示出其中一行已不复存在于第二次读或后续读中，因为该行已被其他事务删除。同样，由于其他事务的插入操作，事务的第二次读或后续读显示有一行已不存在于原始读中。


```

### 事务处理

```
SQL Server 2008中的事务可以分为两类：系统提供的事务和用户定义的事务。
系统提供的事务是在执行某些T-SQL语句时，一条语句就构成了一个事务，这些语句包括ALTER TABLE、CREATE、DELETE、DROP、FETCH、GRANT、INSERT、OPEN、REVOKE、SELECT、UPDATE、TRUNCATE TABLE。
例如，执行如下创建表的语句：
CREATE TABLE xxx
(
	f1 int NOT NULL,
	f2 char(10) NOT NULL,
	f3 varchar(30) NULL
)

在实际应用中，大量使用的是用户自定义的事务。用户自定义事务的定义方法主要有以下几个步骤。
1．开始事务
在SQL Server中，显式地开始一个事务可以使用BEGIN TRANSACTION语句。
语法格式：
BEGIN { TRAN | TRANSACTION } 
    [ { transaction_name | @tran_name_variable }
      [ WITH MARK [ 'dEscription' ] ]
    ]	
[ ; ]

2．结束事务
COMMIT TRANSCATION语句是提交语句，它将事务开始以来所执行的所有数据都修改成为数据库的永久部分，也标志一个事务的结束，其语法格式为
COMMIT { TRAN | TRANSACTION } 
	[ transaction_name | @tran_name_variable ] ]
[ ; ]
标志一个事务的结束也可以使用COMMIT WORK语句。语法格式为
COMMIT [WORK]
此语句的功能与COMMIT TRANSACTION相同，但COMMIT TRANSACTION接受用户定义的事务名称，而COMMIT WORK不带参数。

3．撤销事务
若要结束一个事务，可以使用ROLLBACK TRANSACTION语句。它使得事务回滚到起点，撤销自最近一条BEGIN TRANSACTION语句以后对数据库的所有更改，同时也标志了一个事务的结束。
语法格式：
ROLLBACK { TRAN | TRANSACTION } 
     [ transaction_name | @tran_name_variable ]
[ ; ]
ROLLBACK TRANSACTION语句不能在COMMIT语句之后。
另外，一条ROLLBACK WORK语句也能撤销一个事务，功能与ROLLBACK TRANSACTION语句一样，但ROLLBACK TRANSACTION语句接受用户定义的事务名称。
语法格式：
ROLLBACK [ WORK ] [ ; ]

4．回滚事务
ROLLBACK TRANSACTION语句除了能够撤销整个事务，还可以使事务回滚到某个点，不过在这之前需要使用SAVE TRANSACTION语句来设置一个保存点。
SAVE TRANSACTION的语法格式：
SAVE { TRAN | TRANSACTION }
 	{ savepoint_name | @savepoint_variable }
[ ; ]
SAVE TRANSACTION语句会向已命名的保存点回滚一个事务。如果在保存点被设置后，当前事务对数据进行了更改，则这些更改会在回滚中被撤销。语法格式为
ROLLBACK { TRAN | TRANSACTION } 
     [ savepoint_name | @savepoint_variable ] 
[ ; ]
其中，savepoint_name是SAVE TRANSACTION语句中的savepoint_name。在事务中允许有重复的保存点名称，但指定保存点名称的ROLLBACK TRANSACTION语句只将事务回滚到使用该名称的最近的SAVE TRANSACTION。

下面几个语句说明了有关事务的处理过程：
① BEGIN TRANSACTION mytran1
② UPDATE …
③ DELETE…
④ SAVE TRANSACTION S1
⑤ DELETE…
⑥ ROLLBACK TRANSACTION S1;
⑦ INSERT…
⑧ COMMIT TRANSACTION

【例11.1】  定义一个事务，向PXSCJ数据库的XSB表添加一行数据，然后删除该行数据；但执行后，新插入的数据行并没有删除，因为事务中使用了ROLLBACK语句将操作回滚到保存点My_sav，即删除前的状态。
BEGIN TRANSACTION My_tran
USE PXSCJ
INSERT INTO XSB
	VALUES('081115', '胡新华', 1, '1991-06-27', '计算机', 50, NULL)
SAVE TRANSACTION My_sav
DELETE FROM XSB WHERE 学号='081115'
ROLLBACK TRAN My_sav
COMMIT WORK
GO

执行完上述语句后使用SELECT语句查询XSB表中的记录：
SELECT * 
	FROM XSB
	WHERE 学号='081115'
执行结果如下：


```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235926.png)





### 事务隔离级

```
在SQL Server 2008中，可以使用SET TRANSACTION ISOLATION LEVEL语句来设置事务的隔离级别。
语法格式：
SET TRANSACTION ISOLATION LEVEL
   {  READ UNCOMMITTED
     | READ COMMITTED
     | REPEATABLE READ
     | SNAPSHOT
     | SERIALIZABLE
   }
[ ; ]
 

（1）未提交读。未提交读提供了事务之间最小限度的隔离，允许脏读，但不允许丢失更新。如果一个事务已经开始写数据，则另外一个事务不允许同时进行写操作，但允许其他事务读取此行数据。该隔离级别可以通过“排他锁”实现。
（2）提交读。提交读是SQL Server 2008默认的隔离级别，处于这一级的事务可以看到其他事务添加的新记录，而且其他事务对现存记录做出的修改一旦被提交，也可以看到。也就是说，这意味着在事务处理期间，如果其他事务修改了相应的表，那么同一个事务的多个SELECT语句可能返回不同的结果。提交读允许不可重复读取，但不允许脏读。该隔离级别可以通过“共享锁”和“排他锁”实现。
（3）可重复读。处于这一级的事务禁止不可重复读取和脏读取，但是有时可能出现幻读。读取数据的事务将会禁止写事务（但允许读事务），写事务则禁止任何其他事务。

（4）快照。处于这一级别的事务只能识别在其开始之前提交的数据修改。在当前事务中执行的语句将看不到在当前事务开始以后由其他事务所做的数据修改。其效果就好像事务中的语句获得了已提交数据的快照，因为该数据在事务开始时就存在。必须在每个数据库中将ALLOW_SNAPSHOT_ISOLATION数据库选项设置为ON，才能开始一个使用SNAPSHOT隔离级别的事务。设置的方法如下：
ALTER DATABASE database_name
	SET ALLOW_SNAPSHOT_ISOLATION ON
（5）序列化。序列化是隔离事务的最高级别，提供严格的事务隔离。它要求事务序列化执行，事务只能一个接着一个地执行，不能并发执行。
隔离级别越高，越能保证数据的完整性和一致性，但是对并发性能的影响也越大。对于大多数应用程序，可以优先考虑把数据库的隔离级别设为READ COMMITTED，它能够避免脏取，而且具有较好的并发性能。

下面就PXSCJ数据库的隔离级别设置做一个简单示范，在SSMS中打开两个“查询分析器”窗口，在第一个窗口中执行如下语句，更新课程表KCB中的信息：
USE PXSCJ
GO
begin tran 	
update KCB set 课程名='计算机导论' where 课程号='101'
由于代码中并没有执行COMMIT语句，所以数据变动操作实际上还没有最终完成。接下来，在另一个窗口里执行下列语句查询KCB表中的数据：
SELECT * FROM KCB
“结果”窗口中将不显示任何查询结果，窗口底部提示“正在执行查询…”。出现这种情况的原因是PXSCJ数据库的默认隔离级别是READ COMMITTED，若一个事务更新了数据，但事务尚未结束，这时就发生了脏读的情况。
在第一个窗口中使用ROLLBACK语句回滚以上操作。这时使用SET语句设置事务的隔离级别为READ UNCOMMITTED，执行如下语句：
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


```





## 锁定

### 锁定粒度

```

在SQL Server中，可被锁定的资源从小到大分别是行、页、扩展盘区、表和数据库，被锁定的资源单位称为锁定粒度。可见，上述5种资源单位其锁定粒度是由小到大排列的。锁定粒度不同，系统的开销将不同，并且锁定粒度与数据库访问并发度是一对矛盾，锁定粒度大，系统开销小，但并发度会降低；锁定粒度小，系统开销大，但并发度可提高。


```



### 锁定模式

```
（1）排他锁。排他锁可以防止并发事务对资源进行访问。其他事务不能读取或修改排他锁锁定的数据。
（2）共享锁。共享锁允许并发事务读取一个资源。当一个资源上存在共享锁时，任何其他事务都不能修改数据。一旦读取数据完毕，资源上的共享锁便立即释放，除非将事务隔离级别设置为可重复读或更高级别，或者在事务生存周期内用锁定提示保留共享锁。
（3）更新锁。更新锁可以防止通常形式的死锁。一般更新模式由一个事务组成，此事务读取记录，获取资源（页或行）的共享锁，然后修改行，此操作要求锁转换为排他锁。如果两个事务获得了资源上的共享锁，然后试图同时更新数据，则其中的一个事务将尝试把锁转换为排他锁。共享模式到排他锁的转换必须等待一段时间，因为一个事务的排他锁与其他事务的共享锁不兼容，这就是锁等待。第二个事务试图获取排他锁以进行更新。由于两个事务都要转换为排他锁，并且每个事务都等待另一个事务释放共享锁，因此会发生死锁，这就是潜在的死锁问题。
要避免这种情况的发生，可使用更新锁。一次只允许有一个事务可获得资源的更新锁，如果该事务要修改锁定的资源，则更新锁将转换为排他锁；否则为共享锁。
（4）意向锁。意向锁表示SQL Server需要在层次结构中的某些底层资源（如表中的页或行）上获取共享锁或排他锁，例如，放置在表级的共享意向锁表示事务打算在表中的页或行上放置共享锁。在表级设置意向锁可防止另一个事务随后在包含那一页的表上获取排他锁。意向锁可以提高性能，因为SQL Server仅在表级检查意向锁来确定事务是否可以安全地获取该表上的锁，而无须检查表中的每行或每页上的锁以确定事务是否可以锁定整个表。
意向锁包括意向共享（IS）、意向排他（IX）以及与意向排他共享（ISX）。
意向共享锁：通过在各资源上放置共享锁，表明事务的意向是读取层次结构中的部分底层资源。
意向排他锁：通过在各资源上放置排他锁，表明事务的意向是修改层次结构中部分底层资源。
意向排他共享锁：通过在各资源上放置意向排他锁，表明事务的意向是读取层次结构中的全部底层资源并修改部分底层资源。
（5）键范围锁。键范围锁用于序列化的事务隔离级别，可以保护由T-SQL语句读取的记录集合中隐含的行范围。键范围锁可以防止幻读，还可以防止对事务访问的记录集进行幻像插入或删除。
（6）架构锁。执行表的数据定义语言操作（如增加列或删除表）时使用架构修改锁。
当编译查询时，使用架构稳定性锁。架构稳定性锁不阻塞任何事务锁，包括排他锁。因此在编译查询时，其他事务（包括在表上有排他锁的事务）都能继续运行，但不能在表上执行DDL操作。
（7）大容量更新锁。当将数据大容量复制到表，且指定了TABLOCK提示或者使用sp_tableoption设置了table lock on bulk表选项时，将使用大容量更新锁。大容量更新锁允许进程将数据并发地大容量复制到同一表，同时可防止其他不进行大容量复制数据的进程访问该表。




```



## SQL Server 2008自动化管理

```
在SQL Server 2008中要进行自动化管理，需要按以下步骤进行操作：
（1）确定哪些管理任务或服务器事件定期执行，以及这些任务或事件是否可以通过编程方式进行管理。
（2）使用自动化管理工具定义一组作业、计划、警报和操作员。
（3）运行已定义的SQL Server代理作业。
SQL Server 2008自动化管理能够实现以下几种管理任务：
（1）任何T-SQL语法中的语句；
（2）操作系统命令；
（3）VBScript或JavaScript之类的脚本语言；
（4）复制任务；
（5）数据库创建和备份；
（6）索引重建；
（7）报表生成。


```



### SQL Server代理

```
SQL Server代理服务启动以后需要正确配置SQL Server代理。SQL Server代理的配置信息主要保存在系统数据库msdb的表中，使用SQL Server用户对象来存储代理的身份验证信息。在SQL Server中，必须将SQL Server代理配置为使用sysadmin固定服务器角色成员的账户，才能执行其功能。该账户必须拥有以下Windows权限：
调整进程的内存配额；
以操作系统方式操作；
跳过遍历检查；
作为批处理作业登录；
作为服务登录；
替换进程级记号。
如果需要验证账户是否已经设置了所需的Windows权限，可以通过以下步骤进行：
（1）单击“开始”菜单，选择“程序→管理工具→本地安全策略”。
（2）在弹出的“本地安全设置”窗口中，选择“本地策略→用户权利指派”。
（3）在右侧的权限列表中右击一个权限选项，如“作为服务器登录”，选择“属性”菜单项，如图11.1所示。在打开的“属性”窗口中，从列表中查看要设置的SQL Server代理的账户是否存在，如图11.2所示。
（4）如果账户不在列表中，单击“添加用户或组”按钮，在打开的“选择用户或组”对话框中添加SQL Server代理服务账户，再单击“确定”按钮返回。
（5）重复上述操作，对权限列表中的其他选项进行相同的设置。
通常情况下，为SQL Server代理选择的账户都是为此目的创建的域账户，并且有严格控制的访问权限。使用域账户不是必需的，但是如果使用本地计算机上的账户，那么SQL Server代理就没有权限访问其他计算机上的资源。SQL Server需要访问其他计算机的情况很常见，例如，当它在另一台计算机上的某个位置创建数据库备份和存储文件时。




```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235927.png)







### 操作员

```
每一个操作员都必须具有一个唯一的名称，操作员的联系信息决定了通知操作员的方式。通知方式有以下3种：
（1）电子邮件通知。电子邮件通知是向操作员发送电子邮件。对于电子邮件通知，需要提供操作员的电子邮件地址；但是若要使用数据库邮件发送电子邮件，则必须具有访问支持SMTP的电子邮件服务器的权限。若要使用SQL Mail功能发送电子邮件，则必须具有访问Exchange服务器的权限，必须在运行SQL Server的计算机上安装Outlook和Exchange Client。
（2）寻呼通知。寻呼是通过电子邮件实现的。对于寻呼通知，需要提供操作员接收寻呼消息的电子邮件地址。若要设置寻呼通知，就必须在邮件服务器上安装软件，处理入站邮件并将其转换为寻呼消息。
（3）net send通知。此方式通过net send命令向操作员发送消息。对于net send，需要指定网络消息的收件人（计算机或用户）。

创建操作员的步骤如下。
第1步：使用系统管理员身份连接SQL Server，启动SQL Server Management Studio，查看SQL Server代理服务是否运行，如果未运行，则右击“SQL Server代理”，选择“启动”菜单项启动SQL Server代理服务。如果服务已经运行，则展开“SQL Server代理”，右击“操作员”节点，选择“新建操作员”菜单项。
第2步：进入“新建操作员”窗口，在“姓名”文本框中输入操作员名称，如tao；在“电子邮件名称”文本框中输入通知操作员的电子邮件，如tao@163.com。如果需要指定net send通知，则可以在“Net Send”文本框中输入计算机名。如果操作员携带了可以接收电子邮件的传呼机，则可以在“寻呼电子邮件名称”文本框中输入电子邮件。

第3步：在“寻呼值班计划”栏中，可以选择操作员接收通知的时间。例如，选择“星期一”复选框，并设置“工作日开始时间”和“工作日结束时间”，如图11.3所示，则操作员将在每个星期一的这个时间段接到通知。
第4步：设置完后单击“确定”按钮完成操作员的创建。


```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235928.png)





### 作业

```
第1步：启动SQL Server Management Studio，在“对象资源管理器”窗口中展开“SQL Server代理”，右击“作业”，选择“新建作业”菜单项，打开“新建作业”窗口。

第2步：选择“常规”选项卡，在“名称”文本框中输入要定义的作业名称，如“创建并备份数据库”。“所有者”使用默认值。在“类别”下拉框中选择当前作业的类别，如“数据库维护”，如图11.4所示，默认是“未分类（本地）”。“说明”框中可以输入对作业的描述信息。

第3步：选择“步骤”选项卡，在右侧单击“新建”按钮，弹出“新建作业步骤”窗口。在窗口中的“步骤名称”文本框中定义一个作业步骤的名称，如“新建数据库”。在“类型”下拉框中选择作业步骤的类型，这里选择“Transact-SQL脚本（T-SQL）”。如果作业步骤是对数据库直接操作，则可以在“数据库”下拉框中选择目标数据库，这里使用默认值。在“命令”文本框中输入创建新数据库的T-SQL语句，如图11.5所示。

第4步：在“新建作业步骤”窗口中可以单击“分析”按钮分析SQL命令的正确性，如果语句正确则选择“高级”选项卡，可以设置“成功时要执行的操作”和“失败时要执行的操作”，这里使用默认值。单击“确定”按钮返回。

第5步：返回“新建作业”窗口后，窗口中的“作业步骤列表”中将显示刚刚新建的作业步骤。这时可以再单击“新建”按钮，添加备份数据库的作业步骤（过程略），新建后的作业步骤如图11.6所示。

第6步：选择“计划”选项卡，单击“新建”按钮，弹出“新建作业计划”窗口，如图11.7所示。在窗口中，在“名称”文本框中输入要创建的作业计划的名称。在“计划类型”下拉框中可以选择“重复执行”、“执行一次”等选项。如果选择“重复执行”，还可以设置执行的频率、持续时间等选项。如果选择“执行一次”，可以设置具体的执行时间。设置完成后单击“确定”按钮返回“新建作业”窗口。

第7步：选择“通知”选项卡，选择作业完成时要执行的操作。例如，可以选择“电子邮件”复选框，在后面的第一个下拉框中选择要通知的操作员，如tao。在第二个下拉框中选择通知操作员的时机，如果选择了“当作业完成时”选项则包括“当作业成功时”和“当作业失败时”。如图11.8所示，这样设置以后，在作业完成时可以使用电子邮件通知方式通知操作员。其他的选项可以根据用户需要自行设置，例如，如果需要在作业运行之后就将该作业删除，可以选择“自动删除作业”复选框。

第8步：单击“确定”按钮完成作业的创建。此后，作业会按照之前的设定开始按计划执行。如果要查看作业的执行情况，可以展开“SQL Server代理”的“作业”节点，右击刚刚创建的作业“创建并备份数据库”，选择“查看历史记录”菜单项，在“日志文件查看器”窗口中即可查看作业执行的历史记录。

```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235929.png)

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235930.png)

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235931.png)

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235932.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235933.png)









### 警报

```
1．事件警报
要创建基于SQL Server事件的警报，必须先把错误写到Windows事件日志上，因为SQL Server代理会从该事件日志上读取错误信息。一旦SQL Server代理读取了该事件日志并检测到了新错误，就会搜索整个数据库，查找匹配的警报。当这个代理发现匹配的警报时，该警报立即被激活，进而可以通知操作员，执行作业或者同时做这两件事情。可以指定一个警报响应一个或多个事件。
可以使用下列参数来指定触发警报的SQL Server事件：
（1）错误号。SQL Server代理在发生特定错误时发出警报。例如，可以指定错误号2571来响应未经授权就尝试调用数据库控制台命令（DBCC）的操作。

（2）严重级别。SQL Server代理在发生特定级别的严重错误时发出警报。例如，可以指定严重级别15来响应T-SQL语句中的语法错误。SQL Server中的每个错误都有一个关联的严重级别，用于指示错误的严重程度。表11.1中列出了常见的错误严重级别及说明。

（3）数据库。SQL Server代理仅在特定数据库中发生事件时才发出警报。此选项是对错误号或严重级别的补充。例如，如果实例中包含一个用于生产的数据库和一个用于报告的数据库，可以定义仅响应生产数据库中的语法错误的警报。
（4）事件文本。SQL Server代理在指定事件的事件消息中包含特定文本字符串时发出警报。例如，可以定义警报来响应包含特定表名或特定约束的消息。

```



SQL Server常见的错误严重级别及说明

| 级    别 | 说    明                                         | 是否写入应用程序日志 |
| -------- | ------------------------------------------------ | -------------------- |
| 0~10     | 消息，不是错误                                   | 可选                 |
| 11~16    | 用户错误，可纠正                                 | 可选                 |
| 17       | 在服务器资源耗尽时产生的错误                     | 可选                 |
| 18       | 非致命的内部错误。语句将完成，并且用户连接将维持 | 可选                 |
| 19       | 非可配置资源错误，产生这个错误的任何语句将被终止 | 是                   |
| 20       | 当前数据库的一个单独进程遇到问题                 | 是                   |
| 21       | 当前数据库的所有进程都受到影响                   | 是                   |
| 22       | 正在使用的表或索引可能受到损坏                   | 是                   |
| 23       | 整个数据库遭到破坏                               | 是                   |
| 24       | 硬件发生故障                                     | 是                   |



```
创建事件警报的具体步骤如下。
第1步：启动SQL Server Management Studio，以Windows系统管理员身份连接SQL Server 2008。在“对象资源管理器”窗口中，展开“SQL Server代理”，右击“警报”，选择“新建警报”菜单项，打开“新建警报”窗口。

第2步：在“新建警报”窗口的“常规”选项卡的“名称”文本框中输入要定义的警报名称，如“警报_PXSCJ”。如果要禁用该警报，则将“启用”复选框中的勾去掉，这里保持默认值。在“类型”下拉框中选择警报的类型为“SQL Server事件警报”。在“数据库名称”下拉框中选择警报作用于的数据库，这里选择“PXSCJ”。启用“错误号”单选按钮可以指定触发警报的错误号，如208，如图11.9所示。也可以启用“严重性”单选按钮，在后面的下拉框中可以指定触发警报的错误严重级别，如果选择的严重级别在19～25之间，就会向Windows应用程序日志发送SQL Server消息，并触发一个警报。

第3步：选择“响应”选项卡，启用“通知操作员”复选框，在操作员列表中选择警报激活后要通知的操作员，如tao，在其之后的复选框中选择通知方式，如图11.10所示。

第4步：选择“选项”选项卡，在“警报错误文本发送方式”下的复选框中选择发送警报的方式，如“电子邮件”和“Net Send”。

第5步：全部设置完成后单击“确定”按钮完成警报的创建。
在事件警报创建完成后，可以在“SQL Server代理”节点的“警报”目录下找到刚新建的警报“警报_PXSCJ”，右击该警报，选择“属性”菜单项，在“历史记录”选项卡中可以查看警报的响应时间和次数。



```





![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235934.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235935.png)



```
2．性能警报
创建性能警报的具体步骤如下。
第1步：打开“新建警报”窗口（步骤略），在“常规”选项卡的“名称”文本框输入警报名称，如“性能警报（tempdb）”。在“类型”下拉框中选择“SQL Server性能条件警报”选项，之后窗口中会出现性能条件警报要定义的选项。
第2步：在“对象”（要监视的性能区域）下拉框中选择“MSSQL$SQL2008:Databases”选项，在“计数器”（要监视的区域的属性）下拉框中选择“Log File(s) Used Size (KB)”选项，在“实例”（要监视的属性的特定实例）下拉框中选择“PXSCJ”，在“计数器满足以下条件时触发警报”选项的第一个下拉框中选择“高于”选项，在“值”文本框中输入5000，如图11.11所示。以上设置表示：为性能对象Databases设置当数据库PXSCJ的日志文件使用超过5000 KB时发出警报。当然，用户可以根据自己的需要定义性能条件警报。
第3步：在“响应”选项卡中设置要在警报激活时通知的操作员，在“选项”选项卡中设置警报错误的发送方式，这和设置事件警报的方法类似，这里不详细说明。最后单击“确定”按钮完成警报的创建。



```



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235936.png)





```
3．WMI警报
Windows Management Instrumentation（Windows管理规范）是一项核心的Windows管理技术，用户可以使用WMI管理本地和远程计算机。WMI是一种规范和基础结构，通过它可以访问、配置、管理和监视几乎所有的Windows资源，比如用户可以在远程计算机上启动一个进程，设定一个在特定日期和时间运行的进程，远程启动计算机，获得本地或远程计算机的已安装程序列表，查询本地或远程计算机的Windows事件日志，等等。WMI警报就是指定发出警报来响应特定的WMI事件。创建WMI警报也是在“新建警报”窗口中进行的，这里不详细介绍。


```





### 数据库邮件



```
1．可靠性
（1）无需Microsoft Outlook或扩展消息处理应用程序编程接口（扩展 MAPI）。数据库邮件使用标准的简单邮件传输协议（SMTP）发送邮件，无须在运行SQL Server的计算机上安装扩展MAPI客户端便可以使用数据库邮件。
（2）进程隔离。若要最大程度地减小对SQL Server的影响，传递电子邮件的组件必须在SQL Server外围的单独进程中运行。
（3）故障转移账户。数据库邮件配置文件允许指定多台SMTP服务器。
（4）群集支持。数据库邮件与群集兼容，并且可以完全用于群集中。
2．灵活性
（1）后台传递。数据库邮件提供后台（或异步）传递。
（2）多个配置文件。数据库邮件允许在一个SQL Server实例中创建多个配置文件。
（3）多个账户。每个配置文件都可以包含多个故障转移账户。
（4）64位兼容性。数据库邮件完全可以用于采用64位安装的SQL Server。
3．安全性
（1）为了减少SQL Server的外围应用，在默认情况下，禁用数据库邮件存储过程。
（2）必须是msdb数据库中的DatabaseMailUserRole数据库角色的成员，才能发送数据库邮件。
（3）数据库邮件增强了邮件配置文件的安全性。
（4）数据库邮件增强了对附件文件大小的可配置限制。
（5）数据库邮件维护一个禁止的文件扩展名列表，用户无法附加扩展名为列表中某个扩展名的文件。
4．兼容性
（1）集成配置。数据库邮件在SQL Server数据库引擎中维护电子邮件账户的信息。SQL Server 2008的数据库邮件配置向导提供了十分方便的界面来配置数据库邮件，另外还可以使用Transact-SQL语句创建并维护数据库邮件的配置。
（2）日志记录。数据库邮件将电子邮件活动记录到SQL Server、Microsoft Windows应用程序事件日志和msdb数据库的表中。
（3）审核。数据库邮件将发送的邮件和附件的副本保留在msdb数据库中，用户可以轻松地审核数据库邮件的使用情况并检查保留的邮件。
（4）数据库邮件允许以HTML格式发送电子邮件。


第1步：启动SQL Server Management Studio，以系统管理员身份连接SQL Server。在“对象资源管理器”窗口中展开“管理”节点，右击“数据库邮件”，选择“配置数据库邮件”选项，弹出“配置数据库邮件向导”窗口。


第2步：单击“下一步”按钮进入“选择配置任务”窗口，如图11.12所示。按照默认选项单击“下一步”按钮，如果SQL Server未启用数据库邮件功能，则会弹出“是否启用此功能”对话框，单击“是”按钮启用数据库邮件功能。


第3步：进入“新建配置文件”窗口，在“配置文件名”文本框中输入要配置的文件名，如“DatabaseMail”，在“说明”文本框中可以输入对该配置文件的说明，如图11.13所示。

第4步：单击“新建配置文件”窗口的“添加”按钮，弹出“新建数据库邮件账户”窗口，在“账户名”文本框中输入一个账户名；在“电子邮件地址”文本框输入用于发送电子邮件的Email地址，如“david@163.com”；“显示名称”和“答复电子邮件”文本框可以指定显示名称和答复邮件的地址；“服务器名称”文本框中指定邮箱服务器地址，如“smtp.163.com”，端口号默认为25；在“SMTP身份验证”栏，可以选择“基本身份验证”选项，在“用户名”和“密码”栏指定邮箱账户和密码，当然也可以根据需要选择其他选项。填写结果如图11.14所示。

第5步：单击“确定”按钮返回“新建配置文件”窗口，单击“下一步”按钮进入“管理配置文件安全性”窗口，在“公共配置文件”选项卡中，选中刚新建的配置文件的“公共”复选框，将“默认配置文件”选项设为“是”，如图11.15所示。

第6步：单击“下一步”按钮，进入“配置系统参数”窗口，可以配置系统参数。这里按照默认设置不做修改，单击“下一步”按钮进入“完成该向导”窗口，单击“完成”按钮。数据库邮件配置成功后单击“关闭”按钮关闭向导。此时可在“对象资源管理器”窗口的“管理”节点下右击“数据库邮件”，选择“发送测试电子邮件”菜单项，在弹出的对话框中选择新建的配置文件“DatabaseMail”，并输入收件人的Email地址，单击“发送测试电子邮件”按钮。在对应的邮箱中查看是否收到此测试邮件。




```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235937.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235938.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235939.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235940.png)



```
数据库邮件配置完成后创建了一个名为DatabaseMail的配置文件，可以在SQL Server代理中使用该配置文件来发送电子邮件给操作员，具体步骤如下。
第1步：在“对象资源管理器”窗口中右击“SQL Server代理”，选择“属性”菜单项。在“常规”选项卡中，在“Net send收件人”文本框中指定Net Send收件人，一般为主机名或IP地址，如0BD7E57C949A420。

第2步：在“警报系统”选项卡，启用“启用邮件配置文件”。在“邮件系统”下拉框中选择“数据库邮件”选项，在“邮件配置文件”下拉框中选择刚创建的“DatabaseMail”选项，如图11.16所示。

第3步：单击“确定”按钮完成设置，重启SQL Server代理服务。
这时可以在SQL Server代理中创建从SQL Server接收电子邮件的操作员，在要执行的作业或警报中指定以电子邮件形式通知该操作员。之后在作业执行完成或警报激活时，SQL Server将发送电子邮件到操作员的邮箱中。


```



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235941.png)





### 维护计划向导

```
使用维护计划向导创建维护计划的具体步骤如下。
第1步：首先启动SQL Server代理服务，接着以系统管理员身份连接SQL Server，展开“对象资源管理器”窗口的“管理”节点，右击“维护计划”，选择“维护计划向导”菜单项，弹出“SQL Server维护计划向导”窗口，单击“下一步”按钮。
第2步：进入“选择计划属性”窗口，在“名称”文本框中输入要执行的维护计划的名称，如“管理数据库”。在“说明”文本框中可以输入要对维护计划的说明信息。如果要对维护计划的每项任务制定单独的计划，可以选中“每项任务单独计划”单选按钮，如果要对整个计划统筹安排或暂不制定计划，则可以选择“整个计划统筹安排或无计划”单选按钮。如果要对整个计划统筹安排，则可以单击“更改”按钮设定使用计划的时间和频率。这里暂不制定计划，如图11.17所示。
第3步：单击“下一步”按钮进入“选择维护任务”窗口，可以按需要选择要进行的维护任务。为了便于说明操作步骤，这里选择除“清除维护任务”之外的全部维护任务，如图11.18所示，读者可以根据自己的需要进行选择。单击“下一步”按钮进入“选择维护任务顺序”窗口，通过单击“上移”和“下移”按钮，可以对已经选择的维护任务指定先后顺序，这里采用默认顺序。

第4步：单击“下一步”按钮进入“定义‘数据库检查完整性’任务”窗口，在“数据库”下拉框中选择“PXSCJ”数据库，如图11.19所示。当然，还可以根据需要选择“所有数据库”、“系统数据库”等选项。

第5步：单击“下一步”按钮进入“定义‘收缩数据库’任务”窗口，在“数据库”下拉框中选择需要收缩的数据库，如PXSCJ，之后可以对要收缩数据库的条件和选项进行设定，这里保持默认值，如图11.20所示。

第6步：单击“下一步”按钮进入“定义‘重新组织索引’任务”窗口，选择PXSCJ数据库，“对象”栏选择“表”，“选择”栏选择“所有对象”。当然，用户也可以根据自己的需要进行设定。单击“下一步”按钮进入“定义‘重新组织索引’任务”窗口，按之前的方法对其中的选项进行相同的设定。其中，“使用默认可用空间重新组织页”选项表示该选项填充因子重新产生页面，“将每页的可用空间百分比改为”表示该选项创建一个新的填充因子，如设为20%，表示页面将包含20%的自由空间。


第7步：单击“下一步”按钮进入“定义‘更新统计信息’任务”窗口，统计信息基于一个值在列中出现的次数，由于列中的值有变化，所以统计信息需要更新以反映那些变化。在“数据库”下拉框中选择PXSCJ，在“对象”下拉框中选择“表”，在“选择”下拉框中选择“所有对象”，如图11.21所示。

第8步：单击“下一步”按钮进入“定义‘清除历史记录’任务”窗口，在该窗口中可以选择要清除的历史记录，这里保持默认值，如图11.22所示。

第9步：单击“下一步”按钮进入“定义‘执行SQL Server代理作业’任务”窗口，选择要执行的SQL Server代理作业，如图11.23所示。

第10步：单击“下一步”按钮进入“定义‘备份数据库（完整）’任务”窗口，在“数据库”下拉框中选择PXSCJ数据库，其他选项用户可以根据需要进行设定，如图11.24所示。单击“下一步”按钮进入“定义‘备份数据（差异）’任务”窗口和“定义‘备份数据库（事务日志）’任务”窗口，设置方法与之前类似。

第12步  单击“下一步”按钮进入“选择报告选项”窗口，这里可以设置“将报告写入文本文件”并指定具体的路径，这里保持默认值。如果需要将报告发送给操作员，则选中“以电子邮件形式发送报告”，并设置收件人为相应的操作员，如图11.25所示。
单击“下一步”按钮进入“完成该向导”窗口，查看计划执行的步骤，单击“完成”按钮，结果如图11.26所示。最后单击“关闭”按钮关闭该窗口。


```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235942.png)

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235943.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235944.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235945.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235946.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235947.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235948.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235949.png)

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235950.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235951.png)



## SQL Server 2008服务



```
SQL Server 2008的服务平台是指对SQL Server的组成部分和这些组成部分之间关系的描述。SQL Server 2008的服务一共由4部分组成：数据库引擎、集成服务（Integration Services）、报表服务（Reporting Services）和分析服务（Analysis Services）。通过选择不同的数据库服务，可以完成不同的数据库操作。SQL Server 2008中各个服务的体系结构如图11.29所示。 

```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235952.png)

### 集成服务

```
SQL Server 2008中集成服务的具体用途主要体现在以下几个方面。
（1）整理和标准化数据。集成服务包含了一些内置转换，可将其添加到包中以达到清理数据和将数据标准化、更改数据的大小写、将数据转换成不同类型或格式，或者根据表达式创建新列值等目的。其中，包是一个有组织的集合，包括连接、控制流元素、数据流元素、事件处理程序、变量和配置。使用SSIS工具可以设计、创建、部署和管理包，从而处理日常的义务需求。
包还可以使用精确查找或模糊查找来找到引用表中的值，通过将列中的值替换为引用表中的值来清理数据。通常包首先使用精确查找，如果该查找失败再使用模糊查找。
（2）为数据仓库提供数据。集成服务作为ETL在SQL Server中的实现渠道，是为数据仓库提供数据的主要来源，集成服务包含了一个可直接将数据从平面文件大容量加载到SQL Server表和视图中的任务，还包含了一个目标组件，该组件可以在数据转换过程的最后一步将数据大容量加载到SQL Server数据库中。

（3）实现数据的跨平台存储。数据通常存储在很多不同的数据存储系统中。集成服务可以连接到各种数据源，从所有的源中提取数据并将其合并到单个一致的数据集中。SSIS包可以使用.NET和OLE DB访问接口连接到关系数据库，还可以使用ODBC驱动程序连接到早期的数据库。包还可以连接到平面文件、Excel文件和SQL Server的分析服务项目。
（4）在数据转换过程中实现商业智能。集成服务提供了用于将商业智能置入SSIS包的容器、任务和转换的功能。


```



###  报表服务

```
通过报表服务可以可视化地完成报表设计过程的交互工作，并且在Web上完成绝大多数的报表管理工作，还可以在运行时对报表的内容进行筛选。SQL Server Reporting Services的服务体系结构如图11.30所示。


```

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200121235953.png)



```
报表服务为所有组织的报表需求建立了新的标准，把一个单一的、完整的报表平台和一个可伸缩的、可扩展的架构结合在一起，来满足对报表的不同需求，包括以下几种。
（1）企业报表。企业可以使用报表服务来制作内部报表或者商业智能的应用。使用报表服务，公司内部的IT人员可以设计出各种不同的报表，并将它们发布给整个企业中的每个人。 
（2）即席报表。SQL Server 2008报表服务包括一个报表生成器。它是一种新的、特别的即席报表工具，能确保商业用户创建自己的报表和浏览企业数据。报表生成器包含有利于用户的商业查询模式，确保用户无须在技术上深入理解潜在数据源即能建立报表。
（3）嵌入式报表。独立软件开发商（ISV）可以使用报表服务来发布作为应用包一部分的、已经预定义好的报表。客户的IT机构可以访问这些报表或者使用报表服务来自定义报表，也可以针对特殊的业务需要建立新的报表。对于独立软件开发商来讲，报表服务提供了将灵活的可交互的报表嵌入应用的一个简单模式。
（4）面向合作伙伴和客户的基于Web的报表。组织可以通过部署传统的或者交互式的基于Web的报表来通过Internet的extranets与客户或者合作伙伴交流。报表服务将报表消费者从复杂的底层数据源分离，同时提供了个性化与交互性。

SQL Server报表服务支持完整的报表生命周期，包括： 
（1）报表制作。通过使用Microsoft或其他使用报表定义语言（RDL）的设计工具，报表开发人员可制作发布在报表服务之上的报表。报表定义语言（RDL）是基于XML的用于定义报表的行业标准。 
（2）报表管理。报表定义、文件夹和资源被作为一项Web服务来发表和管理。受管理的报表可根据随机请求或按特定进度被执行，并且在一致性和性能方面提供了缓存方式。在SQL Server 2008报表服务中，管理员能使用SSMS来组织报表和数据源、确定报表执行的进度、交付和跟踪报表历史记录。 
（3）报表提交。报表服务支持随机请求的方式提交，以及基于时间表或事件的方式提交。用户可基于WEB格式或者通过电子邮件阅读报表。  
（4）报表安全。SQL Server报表服务实施一种灵活的基于角色的安全模式，从而保护了报表与数据源。该产品也包含为整合其他安全模式提供的可扩展的界面。
 表述尚欠清晰，请润色。
 
 


```



### 分析服务

```
数据挖掘就是指从大量的数据中提取出有价值的信息。SQL Server 2008中的数据挖掘不仅功能强大和易于访问，并且与很多在进行分析和报告工作时常用的工具集成在一起。用户使用SQL Server 2008分析服务中的数据挖掘工具有助于识别数据中的模式，从而确定出现问题的原因，还可以在分析服务中轻松地挖掘创建的OLAP多维数据集。SQL Server 2008分析服务包含创建复杂数据挖掘解决方案所需的如下功能和工具：
一组行业标准数据挖掘算法。
数据挖掘设计器，可用于创建、管理和浏览数据挖掘模型，并随后使用这些模型创建预测。
数据挖掘扩展插件（DMX）语言，可用于管理挖掘模型和创建复杂的预测查询。


```



















































