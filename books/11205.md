# SQL Server

## 表和表结构

每个数据库包含了若干个表。表是SQL Server中最主要的数据库对象，它是用来存储数据的一种逻辑结构。表由行和列组成，因此也称为二维表。表是在日常工作和生活中经常使用的一种表示数据及其关系的形式，表3.1就是用来表示学生情况的一个学生表。

表3.1  学生表

| 学    号 | 姓    名 | 性    别 | 出 生 时 间 | 专    业 | 总  学  分 | 备    注               |
| -------- | -------- | -------- | ----------- | -------- | ---------- | ---------------------- |
| 081101   | 王林     | 男       | 1990-02-10  | 计算机   | 50         |                        |
| 081103   | 王燕     | 女       | 1989-10-06  | 计算机   | 50         |                        |
| 081108   | 林一帆   | 男       | 1989-08-05  | 计算机   | 52         | 已提前修完一门课       |
| 081202   | 王林     | 男       | 1989-01-29  | 通信工程 | 40         | 有一门课不及格，待补考 |
| 081204   | 马琳琳   | 女       | 1989-02-10  | 通信工程 | 42         |                        |
下面简单介绍与表有关的几个概念：

（1）表结构。组成表的各列的名称及数据类型，统称为表结构。

（2）记录。每个表包含了若干行数据，它们是表的“值”，表中的一行称为一个记录。因此，表是记录的有限集合。

（3）字段。每个记录由若干个数据项构成，将构成记录的每个数据项称为字段。例如，表3.1中表结构为（学号，姓名，性别，出生时间，专业，总学分，备注），包含7个字段，由5个记录组成。

（4）空值。空值（NULL）通常表示未知、不可用或将在以后添加的数据。若一个列允许为空值，则向表中输入记录值时可不为该列给出具体值；而一个列若不允许为空值，则在输入时必须给出具体值。

（5）关键字。若表中记录的某一字段或字段组合能唯一标识记录，则称该字段或字段组合为候选关键字（Candidate key）。若一个表有多个候选关键字，则选定其中一个为主关键字（Primary key），也称为主键。当一个表仅有唯一的一个候选关键字时，该候选关键字就是主关键字。这里的主关键字与第1章中的主码所起的作用是相同的，都用来唯一标识记录行。



```

例如，在学生表中，2个及其以上记录的姓名、性别、出生时间、专业、总学分和备注这6个字段的值有可能相同，但是“学号”字段的值对表中所有记录来说一定不同，即通过“学号”字段可以将表中的不同记录区分开来。所以，“学号”字段是唯一的候选关键字，学号就是主关键字。再例如，学生成绩表记录的候选关键字是（学号，课程号）字段组合，它也是唯一的候选关键字。

```





## 视图概念

视图一经定义以后，就可以像表一样被查询、修改、删除和更新。使用视图有下列优点：

（1）为用户集中数据，简化用户的数据查询和处理。有时用户所需要的数据分散在多个表中，定义视图可将它们集中在一起，从而方便用户进行数据查询和处理。

（2）屏蔽数据库的复杂性。用户不必了解复杂的数据库中的表结构，并且数据库表的更改也不影响用户对数据库的使用。

（3）简化用户权限的管理。只需授予用户使用视图的权限，而不必指定用户只能使用表的特定列，也增加了安全性。

（4）便于数据共享。各用户不必都定义和存储自己所需的数据，而可共享数据库的数据，这样，同样的数据只需存储一次。

（5）可以重新组织数据以便输出到其他应用程序中。

在使用视图时，要注意下列事项：

（1）只有在当前数据库中才能创建视图。视图的命名必须遵循标识符命名规则，不能与表同名。

（2）不能把规则、默认值或触发器与视图相关联。







## 游标概念
一个对表进行操作的T-SQL语句通常都可产生或处理一组记录，但是许多应用程序，尤其是T-SQL嵌入到的主语言，通常不能把整个结果集作为一个单元来处理，这些应用程序就需要一种机制来保证每次处理结果集中的一行或几行，游标（cursor）就提供了这种机制。

如果修改字段含义或对字段表示的状态追加时,需要及时更新字段注释。SQL Server通过游标提供了对一个结果集进行逐行处理的能力，游标可看做一种特殊的指针，它与某个查询结果相联系，可以指向结果集的任意位置，以便对指定位置的数据进行处理。使用游标可以在查询数据的同时对数据进行处理。

在SQL Server中，有两类游标可以用于应用程序中：前端（客户端）游标和后端（服务器端）游标。服务器端游标是由数据库服务器创建和管理的游标，而客户端游标是由ODBC 和DB-Library 支持，在客户端实现的游标。

SQL Server对游标的使用要遵循“声明游标→打开游标→读取数据→关闭游标→删除游标”的过程。



## 索引


索引是根据表中一列或若干列按照一定顺序建立的列值与记录行之间的对应关系表。

在数据库系统中建立索引主要有以下作用：

+ 快速存取数据；
+ 保证数据记录的唯一性；
+ 实现表与表之间的参照完整性；

在使用ORDER BY、GROUP BY子句进行数据检索时，利用索引可以减少排序和分组的时间。


1．聚集索引

聚集索引将数据行的键值在表内排序并存储对应的数据记录，使得数据表**物理顺序与索引顺序一致**。SQL Server 2008是按B树（BTREE）方式组织聚集索引的，B树方式构建为包含了多个节点的一棵树。顶部的节点构成了索引的开始点，叫做根。

每个表只会有一个聚集索引。

由于数据记录按聚集索引键的次序存储，故聚集索引对查找记录很有效。

> 按照特定索引

2．非聚集索引

非聚集索引完全独立于数据行的结构。SQL Server 2008也是按B树方式组织非聚集索引的，与聚集索引的不同之处在于：非聚集索引B树的叶节点不存放数据页信息，而是存放非聚集索引的键值，并且每个键值项都有指针指向包含该键值的数据行。

只有在表上创建聚集索引时，表内的行才按特定顺序存储，这些行按聚集索引键顺序存储。如果一个表只有非聚集索引，则它的数据行将按无序的堆集方式存储。

> 按照录入序号



## 存储过程

在SQL Server 2008中，使用T-SQL语句编写存储过程。存储过程可以接收输入参数、返回表格或标量结果和消息，调用“数据定义语言（DDL）”和“数据操作语言（DML）”语句，然后返回输出参数。

使用存储过程的优点如下：

（1）存储过程在服务器端运行，执行速度快。

（2）存储过程执行一次后，就驻留在高速缓冲存储器，在以后的操作中，只需从高速缓冲存储器中调用已编译好的二进制代码执行，提高了系统性能。

（3）使用存储过程可以完成所有数据库操作，并可通过编程方式控制对数据库信息访问的权限，确保数据库的安全。

（4）自动完成需要预先执行的任务。存储过程可以在SQL Server启动时自动执行，而不必在系统启动后再进行手工操作，大大方便了用户的使用，可以自动完成一些需要预先执行的任务。





（1）系统存储过程。系统存储过程是由SQL Server提供的存储过程，可以作为命令执行。系统存储过程定义在系统数据库master中，其前缀是“sp_”，例如，常用的显示系统对象信息的sp_help系统存储过程，为检索系统表的信息提供了方便快捷的方法。系统存储过程允许系统管理员执行修改系统表的数据库管理任务，可以在任何一个数据库中执行。SQL Server 2008提供了很多的系统存储过程，通过执行系统存储过程，可以实现一些比较复杂的操作，本书也介绍了其中一些系统存储过程。要了解所有的系统存储过程，请参考SQL Server联机丛书。

（2）扩展存储过程。扩展存储过程是指在SQL Server 2008环境之外，使用编程语言（如C++语言）创建的外部例程形成的动态链接库（DLL）。使用时，先将DLL加载到SQL Server 2008系统中，并且按照使用系统存储过程的方法执行。扩展存储过程在 SQL Server 实例地址空间中运行；但因为扩展存储过程不易撰写，而且可能会引发安全性问题，所以微软可能会在未来的SQL Server中删除这一功能，本书将不详细介绍扩展存储过程。

（3）用户存储过程。在SQL Server 2008中，用户存储过程可以使用T-SQL语言编写，也可以使用CLR方式编写。在本书中，T-SQL存储过程就称为存储过程。

① 存储过程：存储过程保存T-SQL语句集合，可以接收和返回用户提供的参数。存储过程中可以包含根据客户端应用程序提供的信息，以及在一个或多个表中插入新行所需的语句。存储过程也可以从数据库向客户端应用程序返回数据。例如，电子商务Web应用程序可能根据联机用户指定的搜索条件，使用存储过程返回有关特定产品的信息。

② CLR存储过程：CLR存储过程是对Microsoft .NET Framework公共语言运行时（CLR）方法的引用，可以接收和返回用户提供的参数。它们在“.NET Framework 程序集”中是作为类的公共静态方法实现的。简单地说，CLR存储过程就是可以使用Microsoft Visual Studio 2008环境下的语言作为脚本编写的、可以对Microsoft .NET Framework公共语言运行时（CLR）方法进行引用的存储过程。编写CLR存储过程需要有C#语言的基础，本书将在附录D中具体介绍编写CLR存储过程和CLR触发器的方法。



## 触发器

触发器的类型在SQL Server 2008中，按照触发事件的不同可以将触发器分为两大类：DML触发器和DDL触发器。

（1）DML触发器。当数据库中发生数据操纵语言（DML）事件时将调用DML触发器。一般情况下，DML事件包括对表或视图的INSERT语句、UPDATE语句和DELETE语句，因而DML触发器也可分为三种类型：INSERT、UPDATE和DELETE。

（2）DDL触发器。DDL触发器也是由相应的事件触发的，但DDL触发器触发的事件是数据定义语句（DDL）。这些语句主要是以CREATE、ALTER、DROP等关键字开头的语句。DDL触发器的主要作用是执行管理操作，例如审核系统、控制数据库的操作等。在通常情况下，DDL触发器主要用于以下一些操作需求：防止对数据库架构进行某些修改；希望数据库中发生某些变化以利于相应数据库架构中的更改；记录数据库架构中的更改或事件。DDL触发器只在响应由T-SQL语法所指定的DDL事件时才会触发。










