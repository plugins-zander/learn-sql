# SQL Server2008数据库基本概念

## 1.1基本模式

### 1.1.1 逻辑数据库

用户经常需要在T-SQL中引用SQL Server对象并对其进行操作，如对数据库表进行查询和数据更新等，在其所使用的T-SQL语句中需要给出对象的名称。用户可以给出两种对象名，即完全限定名和部分限定名。

（1）完全限定名。在SQL Server 2008中，完全限定名是对象的全名，包括4个部分：服务器名、数据库名、数据库架构名和对象名，其格式为
```sql
server.database.scheme.object
```
在SQL Server 2008上创建的每一个对象都必须有一个唯一的完全限定名。

（2）部分限定名。在使用T-SQL编程时，常省略全名中的某些部分，对象全名的4个部分中的**前3个部分均可以省略**，当省略中间的部分时，**圆点符“.”不可省略**。把只包含对象完全限定名中的一部分的对象名称为部分限定名。SQL Server可以根据系统的当前工作环境确定对象名称中省略的部分。

在部分限定名中，未指出的部分使用以下默认值。

服务器：默认为本地服务器。

数据库：默认为当前数据库。

数据库架构名：默认为dbo。

```sql
例如，以下是一些正确的对象部分限定名：
server.database...object      	/*省略架构名*/
server.. scheme.object        	/*省略数据库名*/
database. scheme.object      	/*省略服务器名*/
server…object            		/*省略架构名和数据库名*/
scheme.object             		/*省略服务器名和数据库名*/
object                   		/*省略服务器名、数据库名和架构名*/
```


下面大致介绍一下SQL Server 2008中所包含的常用数据库对象。

#### ① 表：

表是SQL Server中最主要的数据库对象，它是用来存储和操作数据的一种逻辑结构。表由行和列组成，因此也称为二维表。表是在日常工作和生活中经常使用的一种表示数据及其关系的形式。 

#### ② 视图：

视图是从一个或多个基本表中引出的表。数据库中只存放视图的定义而不存放视图对应的数据，这些数据仍存放在导出视图的基本表中。

由于视图本身并不存储实际数据，因此也可以称之为**虚表**。视图中的数据来自定义视图的查询所引用的基本表，并在引用时**动态生成数据**。当基本表中的数据发生变化时，从视图中查询出来的数据也随之改变。视图一经定义，就**可以像基本表一样被查询、修改、删除和更新**了。

#### ③ 索引：

索引是一种**不用扫描整个数据表就可以对表中的数据实现快速访问的途径**，它是对数据表中的一列或者多列数据进行排序的一种结构。
表中的记录通常按其**输入的时间顺序存放，这种顺序称为记录的物理顺序**。为了实现对表记录的快速查询，可以对表的记录**按某个或某些属性进行排序，这种顺序称为逻辑顺序**。

索引是根据索引表达式的值进行逻辑排序的一组指针，它可以实现对数据的快速访问，索引是关系数据库的内部实现技术，它被存放在存储文件中。

#### ④ 约束：

约束机制保障了SQL Server 2008中数据的一致性与完整性，具有代表性的约束就是主键和外键。主键约束当前表记录的唯一性，外键约束当前表记录与其他表的关系。

#### ⑤ 存储过程：

存储过程是一组为了完成**特定功能的SQL语句集合（功能函数）**。这个语句集合经过编译后存储在数据库中，存储过程具有接受参数、输出参数、返回单个或多个结果以及返回值的功能。存储过程独立于表存在（表不存在，存储过程存在，但是会出错）。

存储过程有与函数类似的地方，但它又不同于函数，例如，它不返回取代其名称的值，也不能直接在表达式中使用。



--------------

#### ① 触发器：

触发器与表紧密关联。它可以实现更加复杂的数据操作，更加有效地保障数据库系统中数据的完整性和一致性。触发器基于一个表创建，但可以对多个表进行操作。

#### ② 默认值：

默认值是在用户没有给出具体数据时，系统所自动生成的数值。它是SQL Server 2008系统确保数据一致性和完整性的方法。

#### ③ 用户和角色：

用户是指对数据库有存取权限的使用者；角色是指一组数据库用户的集合。这两个概念类似于Windows XP的本地用户和组的概念。

#### ④ 规则：

规则用来限制表字段的数据范围。

#### ⑤ 类型：

用户可以根据需要在给定的系统类型之上定义自己的数据类型。

#### ⑥ 函数：

用户可以根据需要在SQL Server 2008上定义自己的函数。



 

### 1.1.2  物理数据库

#### 1．页和区

SQL Server 2008中有两个主要的数据存储单位：页和区。

**页是用于数据存储的最基本单位**。每个页的大小是8 KB。每页的开头是96 B的标头，用于存储有关页的系统信息。紧接着标头存放的是数据行，数据行按顺序排列。数据库表中的**每一行数据都不能跨页存储**，即表中的每一行数据字节数不能超过8192。页的末尾是行偏移表，页中的每一行在偏移表中都有一个对应的条目。每个条目记录着对应行的第一个字节与页首部的距离。

**区是用于管理空间的基本单位**。每8个连接的页组成一个区，大小为64 KB，即每1 MB的数据库就有16个区。区用于控制表和索引的存储。

 

#### 2．数据库文件

SQL Server 2008所使用的文件包括以下三类文件。

（1）主数据文件。主数据文件简称主文件，正如其名字所示，该文件是数据库的关键文件，包含了数据库的启动信息，并且存储数据。**每个数据库必须有且仅能有一个主文件**，其默认扩展名为**.mdf**。可直接拷贝

（2）辅助数据文件。辅助数据文件简称辅（助）文件，用于存储未包括在主文件内的其他数据。辅助文件的默认扩展名为**.ndf**。辅助文件是可选的，根据具体情况，可以创建多个辅助文件，也可以不使用辅助文件。一般当数据库很大时，有可能需要创建多个辅助文件。而当数据库较小时，则只需要创建主文件而不需要创建辅助文件。

（3）日志文件。日志文件用于保存恢复数据库所需的事务日志信息。每个数据库至少有一个日志文件，也可以有多个，日志文件的扩展名为**.ldf**。日志文件的存储与数据文件不同，它包含一系列记录，这些记录的存储不以页为存储单位。

 

#### 3．文件组

使用文件组可以提高表中数据的查询性能。在SQL Server 2008中有两类文件组。

（1）主文件组。主文件组包含主要数据文件和任何没有明确指派给其他文件组的其他文件。管理数据库的系统表的所有页均分配在主文件组中。

（2）用户定义文件组。用户定义文件组是指在CREATE DATABASE或ALTER DATABASE语句中使用FILEGROUP关键字指定的文件组。

每个数据库中都有一个文件组作为默认文件组运行。若在SQL Server 2008中创建表或索引时没有为其指定文件组，那么将从默认文件组中进行存储页分配、查询等操作。用户可以指定默认文件组，如果没有指定默认文件组，则主文件组是默认文件组。

 

## 2.数据库和数据库文件



### 2.1.1 数据库的组成

　　从操作系统的角度看，作为存储数据的逻辑对象，数据库最终是以文件的形式保存在磁盘上。这些文件就是所谓的数据库文件。**数据库文件又分为数据文件和日志文件。**
　　**数据文件**是数据库用于存储数据的操作系统文件，它保存了数据库中的全部数据。数据文件又分为主数据文件和次要数据文件。主数据文件是数据库的起点，指向数据库的其他文件。每个数据库有且仅有一个主数据文件，而次要数据文件可以有多个或没有。主数据文件的默认扩展名是.mdf，次要数据文件的默认扩展名是.ndf。
       **日志文件**记录了针对数据库的所有修改操作，其中每条日志记录可能是记录了所执行的逻辑操作，也可能记录了已修改数据的前像和后像。前像是操作执行前的数据复本；后像是操作执行后的数据复本。日志文件包含了用于恢复数据库的所有日志信息。利用日志文件，可以在数据库出现故障或崩溃时把它恢复到最近的状态，从而最大限度地减少由此带来的损失。在创建数据库的时候，默认创建一个日志文件被，其推荐的文件扩展名是.ldf。每个数据库至少有一个日志文件，当然也可以有多个。
　　数据文件和日志文件可以保存在FAT或NTFS文件系统中。但从安全性角度考虑，一般使用NTFS文件系统保存这些文件。数据文件名和日志文件名是面向操作系统的，即操作系统是通过这些名称来访问数据文件和日志文件。
　　从逻辑结构看，数据库是数据表的集合，此外数据库还包含索引、视图等“附属部件”，数据表、索引、视图等统称为数据库对象。在创建数据库的时候，我们要给数据库输入一个合法的字符串作为数据库的名称，这个名称简称为数据库名。
　　数据库名是数据库的逻辑名称，应用程序对数据库对象的访问必须通过数据库名来完成，即数据库名是面向应用程序的（而非操作系统，数据库文件是面向操作系统的）。另外，支撑数据库的数据文件和日志文件也有面向应用程序的名称，分别称为数据文件和日志文件的逻辑文件名。通过逻辑文件名，SQL语句就可以有限度地访问和操作数据文件和日志文件。为了区别于逻辑文件名，数据文件和日志文件对应的磁盘文件（即.mdf文件、.ndf文件、.ldf文件）称为它们的物理文件名。
　　对于每个数据文件和日志文件，它们既有自己的逻辑文件名（面向应用程序），也有自己的物理文件名（面向操作系统）。在SQL Server 2014中，当创建数据库时会自动生成一个主数据文件和一个日志文件。在默认情况下，主数据文件的逻辑文件名与数据库名（数据库名由用户设置）相同，其物理文件名等于其逻辑文件名加上扩展名“.mdf”；日志文件的逻辑文件名等于数据库名加上“_log”，日志文件的物理文件名等于数据库名加上“_log.ldf”。
  【例子】 当创建一个名为MyDatabase的数据库时，会自动形成一个主数据文件和一个日志文件，其默认的逻辑文件和物理文件名如表7.1所示。

![img](https://img1.zlogs.net/20/20200121213527.png)

 

### 2.1.2 文件组

　　文件组是数据文件的一种逻辑划分。文件组就是将若干个数据文件放在一起而形成的文件集。
　　文件组有两种类型：主文件组（PRIMARY）和用户定义文件组。
　　　　主文件组包含主数据文件和任何没有明确指定文件组的其他数据文件。
　　　　用户定义文件组是用户利用Transact-SQL语句或者在SQL Server Management Studio（SSMS）中通过可视化操作创建的文件组。
　　 一个文件组包含多个不同的数据文件，一个数据文件只能属于一个文件组。一个数据库至少有一个文件组（主文件组），也可能有多个文件组（至多为32767个文件组）。在一个数据库中，有且仅有一个文件组被指定为默认文件组。在数据库创建时主文件组会自动被设置为默认文件组，但我们也可以将用户定义文件组设置为默认文件组。在创建数据表或者其他数据库对象的时候，如果不显式指定文件组，那么这些数据库对象将自动在默认文件组上创建，即被建对象的所有页都在默认文件组中分配。



## 3. 系统数据库和用户数据库

　　系统数据库存储有关SQL Server的系统信息，它们是SQL Server 2008管理数据库的依据。如果系统数据库遭到破坏，那么SQL Server将不能正常启动。在安装SQL Server 2008时，系统将创建4个可见的系统数据库：**master、model、msdb**和**tempdb**。

（1）master数据库包含了SQL Server 2008的登录账号、系统配置、数据库位置及数据库错误信息等，控制用户数据库和SQL Server的运行。
（2）model数据库为新创建的数据库提供模板。
（3）msdb数据库为“SQL Server代理”调度信息和作业记录提供存储空间。
（4）tempdb数据库为临时表和临时存储过程提供存储空间，所有与系统连接的用户的临时表和临时存储过程都存储于该数据库中。
每个**系统数据库都包含主数据文件和主日志文件**。扩展名分别为.mdf 和.ldf，例如master数据库的两个文件分别为master.mdf和master.ldf。























